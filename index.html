<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <header class="header">
            <h1>üéÆ PUBG Store</h1>
            <button id="admin-btn" class="admin-btn" title="–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å" onclick="handleAdminClick()">‚öôÔ∏è</button>
        </header>
        
        <main class="main">
            <div id="products-container" class="products-container">
                <div class="empty-state">
                    <h2>–ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç</h2>
                    <p>–¢–æ–≤–∞—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</p>
                </div>
            </div>
        </main>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∞ -->
        <div id="admin-auth-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                <input type="password" id="admin-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button id="auth-submit" class="btn">–í–æ–π—Ç–∏</button>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
        <div id="add-product-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <form id="product-form">
                    <input type="text" id="product-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" required>
                    <input type="number" id="product-price" placeholder="–¶–µ–Ω–∞" step="0.01" required>
                    <textarea id="product-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" rows="3"></textarea>
                    <input type="file" id="product-image" accept="image/*">
                    <div class="image-preview" id="image-preview"></div>
                    <div class="form-actions">
                        <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                        <button type="button" class="btn btn-secondary" id="cancel-add">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è -->
        <div id="change-password-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>üîê –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h2>
                <form id="change-password-form">
                    <input type="password" id="current-password" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" required>
                    <input type="password" id="new-password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
                    <input type="password" id="confirm-password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
                    <div class="form-actions">
                        <button type="submit" class="btn">üîÑ –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                        <button type="button" class="btn btn-secondary" id="cancel-password">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ GitHub —Ç–æ–∫–µ–Ω–∞ -->
        <div id="github-token-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>üîó GitHub —Ç–æ–∫–µ–Ω</h2>
                <form id="github-token-form">
                    <input type="password" id="github-token-input" placeholder="–í–≤–µ–¥–∏—Ç–µ GitHub —Ç–æ–∫–µ–Ω" required>
                    <div class="form-actions">
                        <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary" id="cancel-token">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
                <div style="margin-top: 16px; font-size: 12px;">
                    <span id="token-status">‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>
                </div>
            </div>
        </div>

        <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
        <div id="admin-panel" class="admin-panel hidden">
            <button id="add-product-btn" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
            <button id="refresh-products-btn" class="btn btn-secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button id="logout-btn" class="btn btn-secondary">–í—ã–π—Ç–∏</button>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω–∞ -->
        <div id="admin-context-menu" class="admin-context-menu hidden">
            <button id="toggle-panel-btn" class="context-menu-item">
                <span>üìã</span> –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
            </button>
            <button id="change-password-btn" class="context-menu-item">
                <span>üîê</span> –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
            </button>
            <button id="github-token-btn" class="context-menu-item">
                <span>üîó</span> GitHub —Ç–æ–∫–µ–Ω
            </button>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Fullscreen Image Overlay -->
    <div id="fullscreen-overlay" class="fullscreen-overlay">
        <img id="fullscreen-image" class="fullscreen-image" src="" alt="">
        <button id="fullscreen-close" class="fullscreen-close">‚úï</button>
    </div>
    
    <script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
const tg = window.Telegram.WebApp;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
tg.ready();
tg.expand();

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
let ADMIN_PASSWORD = localStorage.getItem('admin_password') || 'admin123'; // –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞
const STORAGE_KEY = 'pubg_products';

// GitHub API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
const GITHUB_OWNER = 'Xellouey';
const GITHUB_REPO = 'PubgTGApp';
const GITHUB_FILE = 'products.json';
const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE}`;

// GitHub Personal Access Token (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ localStorage)
let GITHUB_TOKEN = localStorage.getItem('github_token') || null;
let githubSha = null; // –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
let isAdmin = false;
let products = [];

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM (–±—É–¥—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM)
let productsContainer, adminBtn, adminAuthModal, addProductModal, adminPanel;
let adminPassword, authSubmit, addProductBtn, logoutBtn, productForm;
let imagePreview, productImage;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showToast(message, type = 'info', duration = 3000) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    toastContainer.appendChild(toast);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    setTimeout(() => {
        toast.classList.add('removing');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, duration);
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ –∫–ª–∏–∫—É
    toast.addEventListener('click', () => {
        toast.classList.add('removing');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    });
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞ –∞–¥–º–∏–Ω–∞
window.handleAdminClick = function() {
    console.log('handleAdminClick called!');
    
    const adminAuthModal = document.getElementById('admin-auth-modal');
    const adminContextMenu = document.getElementById('admin-context-menu');
    
    if (isAdmin) {
        // –ï—Å–ª–∏ –∞–¥–º–∏–Ω —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        if (adminContextMenu) {
            adminContextMenu.classList.toggle('hidden');
        }
    } else {
        if (adminAuthModal) {
            console.log('Opening modal via onclick');
            adminAuthModal.style.display = 'block';
        }
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ GitHub
async function loadProducts() {
    try {
        showToast('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã...', 'info', 2000);
        
        const response = await fetch(GITHUB_API_URL);
        if (response.ok) {
            const data = await response.json();
            githubSha = data.sha; // –°–æ—Ö—Ä–∞–Ω—è–µ–º SHA –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            
            console.log('GitHub SHA –ø–æ–ª—É—á–µ–Ω:', githubSha);
            
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ base64
            const content = JSON.parse(atob(data.content.replace(/\n/g, '')));
            products = content.products || [];
            
            console.log('–¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ GitHub:', products);
            showToast('‚úÖ –¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success', 2000);
        } else if (response.status === 404) {
            console.log('–§–∞–π–ª —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
            githubSha = null;
            products = [];
            showToast('üìù –§–∞–π–ª —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω', 'info', 2000);
        } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', response.status, response.statusText);
            products = [];
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
        showToast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤', 'error', 3000);
        
        // Fallback –∫ localStorage
        const saved = localStorage.getItem(STORAGE_KEY);
        products = saved ? JSON.parse(saved) : [];
    }
    
    renderProducts();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ GitHub (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
async function saveProducts() {
    if (!isAdmin) {
        console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É');
        return;
    }
    
    try {
        showToast('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ GitHub...', 'info', 3000);
        
        const content = {
            products: products,
            lastUpdated: new Date().toISOString()
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –≤ localStorage –∫–∞–∫ backup
        localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
        localStorage.setItem('products_backup', JSON.stringify(content));
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
        if (!GITHUB_TOKEN) {
            showToast('‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ GitHub —Ç–æ–∫–µ–Ω –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏', 'error', 4000);
            console.log('GitHub —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
            return;
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è GitHub
        const updateData = {
            message: `Update products - ${new Date().toLocaleString()}`,
            content: btoa(JSON.stringify(content, null, 2)) // –ö–æ–¥–∏—Ä—É–µ–º –≤ base64
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º SHA —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (githubSha) {
            updateData.sha = githubSha;
        }
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ GitHub:', updateData);
        console.log('GitHub SHA:', githubSha);
        console.log('–¢–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω:', !!GITHUB_TOKEN);
        
        const response = await fetch(GITHUB_API_URL, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${GITHUB_TOKEN}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        console.log('–û—Ç–≤–µ—Ç GitHub API:', response.status, response.statusText);
        
        if (response.ok) {
            const result = await response.json();
            githubSha = result.content.sha; // –û–±–Ω–æ–≤–ª—è–µ–º SHA –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            showToast('‚úÖ –¢–æ–≤–∞—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å GitHub!', 'success', 3000);
            console.log('–¢–æ–≤–∞—Ä—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ GitHub');
        } else {
            const error = await response.json();
            console.error('–û—à–∏–±–∫–∞ GitHub API:', error);
            showToast(`‚ùå –û—à–∏–±–∫–∞ GitHub: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error', 5000);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤:', error);
        showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error', 3000);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
function renderProducts() {
    if (products.length === 0) {
        productsContainer.innerHTML = `
            <div class="empty-state">
                <h2>üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç</h2>
                <p>–¢–æ–≤–∞—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</p>
            </div>
        `;
        return;
    }

    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    productsContainer.innerHTML = '';
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    products.forEach((product, index) => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.style.animationDelay = `${index * 0.1}s`;
        
        const imageHtml = product.image ? 
            `<div class="product-image-container">
                <img src="${product.image}" alt="${product.name}" class="product-image" onclick="openFullscreen('${product.image}', '${product.name}')">
                <button class="fullscreen-icon" onclick="openFullscreen('${product.image}', '${product.name}')" title="–û—Ç–∫—Ä—ã—Ç—å –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ">‚õ∂</button>
            </div>` : 
            '<div class="product-image"></div>';
        
        productCard.innerHTML = `
            ${imageHtml}
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">${product.price} ‚ÇΩ</div>
                <div class="product-description">${product.description}</div>
                <button class="buy-btn" onclick="buyProduct(${product.id})">
                    <span>üõí –ö—É–ø–∏—Ç—å</span>
                </button>
                ${isAdmin ? `<button class="btn btn-secondary" style="margin-top: 8px; width: 100%; padding: 6px; font-size: 11px;" onclick="deleteProduct(${product.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
            </div>
        `;
        
        productsContainer.appendChild(productCard);
    });
}

// –ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞
function buyProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    const purchaseData = {
        action: 'buy_product',
        product: {
            id: product.id,
            name: product.name,
            price: product.price,
            description: product.description
        },
        user_id: tg.initDataUnsafe?.user?.id,
        timestamp: Date.now()
    };

    tg.sendData(JSON.stringify(purchaseData));
    showToast(`üõí –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∫—É–ø–∫—É "${product.name}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!`, 'info');
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
function deleteProduct(productId) {
    if (!isAdmin) return;
    
    const product = products.find(p => p.id === productId);
    const productName = product ? product.name : '—Ç–æ–≤–∞—Ä';
    
    products = products.filter(p => p.id !== productId);
    saveProducts();
    renderProducts();
    showToast(`üóëÔ∏è "${productName}" —É–¥–∞–ª–µ–Ω`, 'info', 2000);
}

// –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
function openModal(modal) {
    modal.style.display = 'block';
}

function closeModal(modal) {
    modal.style.display = 'none';
}

// –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
window.openFullscreen = function(imageSrc, altText) {
    const overlay = document.getElementById('fullscreen-overlay');
    const image = document.getElementById('fullscreen-image');
    
    image.src = imageSrc;
    image.alt = altText;
    overlay.style.display = 'flex';
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.body.style.overflow = 'hidden';
    
    showToast('üîç –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ', 'info', 2000);
}

window.closeFullscreen = function() {
    const overlay = document.getElementById('fullscreen-overlay');
    overlay.style.display = 'none';
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.body.style.overflow = 'auto';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', () => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    productsContainer = document.getElementById('products-container');
    adminBtn = document.getElementById('admin-btn');
    adminAuthModal = document.getElementById('admin-auth-modal');
    addProductModal = document.getElementById('add-product-modal');
    adminPanel = document.getElementById('admin-panel');
    adminPassword = document.getElementById('admin-password');
    authSubmit = document.getElementById('auth-submit');
    addProductBtn = document.getElementById('add-product-btn');
    logoutBtn = document.getElementById('logout-btn');
    productForm = document.getElementById('product-form');
    imagePreview = document.getElementById('image-preview');
    productImage = document.getElementById('product-image');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
    const changePasswordModal = document.getElementById('change-password-modal');
    const changePasswordForm = document.getElementById('change-password-form');
    const currentPasswordInput = document.getElementById('current-password');
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    const adminContextMenu = document.getElementById('admin-context-menu');
    const togglePanelBtn = document.getElementById('toggle-panel-btn');
    const changePasswordMenuBtn = document.getElementById('change-password-btn');

    console.log('Admin button found:', adminBtn);
    console.log('Admin auth modal found:', adminAuthModal);

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º–Ω—É—é —Ç–µ–º—É
    console.log('Setting dark theme for better visibility');
    document.body.style.backgroundColor = '#1a1a1a';
    document.body.style.color = '#ffffff';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadProducts();
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
    setInterval(async () => {
        if (!isAdmin) { // –¢–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            await loadProducts();
        }
    }, 30000);

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∞
    if (adminBtn) {
        adminBtn.addEventListener('click', (e) => {
            console.log('Admin button clicked via addEventListener!');
            e.preventDefault();
            e.stopPropagation();
            
            if (isAdmin) {
                adminPanel.classList.toggle('hidden');
            } else {
                console.log('Opening admin auth modal');
                openModal(adminAuthModal);
            }
        });
    }

    authSubmit.addEventListener('click', () => {
        if (adminPassword.value === ADMIN_PASSWORD) {
            isAdmin = true;
            adminBtn.style.opacity = '1';
            adminBtn.style.transform = 'scale(1.2)';
            setTimeout(() => {
                adminBtn.style.transform = 'scale(1)';
            }, 200);
            adminPanel.classList.remove('hidden');
            closeModal(adminAuthModal);
            adminPassword.value = '';
            renderProducts();
            showToast('üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!', 'success');
        } else {
            adminPassword.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                adminPassword.style.animation = '';
            }, 500);
            showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!', 'error');
        }
    });

    logoutBtn.addEventListener('click', () => {
        isAdmin = false;
        adminBtn.style.opacity = '0.3';
        adminPanel.classList.add('hidden');
        renderProducts();
        showToast('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏', 'info', 2000);
    });

    addProductBtn.addEventListener('click', () => {
        openModal(addProductModal);
    });

    // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
    const refreshProductsBtn = document.getElementById('refresh-products-btn');
    refreshProductsBtn.addEventListener('click', async () => {
        await loadProducts();
    });

    productImage.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.innerHTML = '';
        }
    });

    productForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const name = document.getElementById('product-name').value;
        const price = document.getElementById('product-price').value;
        const description = document.getElementById('product-description').value;
        const imageFile = productImage.files[0];

        const product = {
            id: Date.now(),
            name,
            price: parseFloat(price),
            description,
            image: null
        };

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading"></span> –î–æ–±–∞–≤–ª—è–µ–º...';
        submitBtn.disabled = true;

        if (imageFile) {
            const reader = new FileReader();
            reader.onload = (e) => {
                product.image = e.target.result;
                products.push(product);
                saveProducts();
                
                // –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
                setTimeout(() => {
                    renderProducts();
                    closeModal(addProductModal);
                    productForm.reset();
                    imagePreview.innerHTML = '';
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    showToast('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                }, 800);
            };
            reader.readAsDataURL(imageFile);
        } else {
            setTimeout(() => {
                products.push(product);
                saveProducts();
                renderProducts();
                closeModal(addProductModal);
                productForm.reset();
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                showToast('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
            }, 800);
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', (e) => {
            const modal = e.target.closest('.modal');
            closeModal(modal);
        });
    });

    document.getElementById('cancel-add').addEventListener('click', () => {
        closeModal(addProductModal);
        productForm.reset();
        imagePreview.innerHTML = '';
    });

    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target);
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
    changePasswordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å
        if (currentPassword !== ADMIN_PASSWORD) {
            currentPasswordInput.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                currentPasswordInput.style.animation = '';
            }, 500);
            showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å!', 'error');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
        if (newPassword !== confirmPassword) {
            confirmPasswordInput.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                confirmPasswordInput.style.animation = '';
            }, 500);
            showToast('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!', 'error');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
        if (newPassword.length < 4) {
            newPasswordInput.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                newPasswordInput.style.animation = '';
            }, 500);
            showToast('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞!', 'error');
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
        localStorage.setItem('admin_password', newPassword);
        window.ADMIN_PASSWORD = newPassword;
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        changePasswordForm.reset();
        closeModal(changePasswordModal);
        
        showToast('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!', 'success');
    });

    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
    document.getElementById('cancel-password').addEventListener('click', () => {
        closeModal(changePasswordModal);
        changePasswordForm.reset();
    });

    // GitHub —Ç–æ–∫–µ–Ω
    const githubTokenBtn = document.getElementById('github-token-btn');
    const githubTokenModal = document.getElementById('github-token-modal');
    const githubTokenForm = document.getElementById('github-token-form');
    
    githubTokenBtn.addEventListener('click', () => {
        adminContextMenu.classList.add('hidden');
        document.getElementById('token-status').textContent = GITHUB_TOKEN ? '‚úÖ –¢–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
        openModal(githubTokenModal);
    });

    githubTokenForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const token = document.getElementById('github-token-input').value.trim();
        if (token) {
            GITHUB_TOKEN = token;
            localStorage.setItem('github_token', token);
            closeModal(githubTokenModal);
            githubTokenForm.reset();
            showToast('‚úÖ GitHub —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
        }
    });

    document.getElementById('cancel-token').addEventListener('click', () => {
        closeModal(githubTokenModal);
        githubTokenForm.reset();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    togglePanelBtn.addEventListener('click', () => {
        adminPanel.classList.toggle('hidden');
        adminContextMenu.classList.add('hidden');
    });

    changePasswordMenuBtn.addEventListener('click', () => {
        adminContextMenu.classList.add('hidden');
        openModal(changePasswordModal);
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', (e) => {
        if (!adminContextMenu.contains(e.target) && !adminBtn.contains(e.target)) {
            adminContextMenu.classList.add('hidden');
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    const fullscreenOverlay = document.getElementById('fullscreen-overlay');
    const fullscreenClose = document.getElementById('fullscreen-close');
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
    fullscreenClose.addEventListener('click', closeFullscreen);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    fullscreenOverlay.addEventListener('click', (e) => {
        if (e.target === fullscreenOverlay) {
            closeFullscreen();
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && fullscreenOverlay.style.display === 'flex') {
            closeFullscreen();
        }
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
window.addEventListener('error', (event) => {
    console.error('–û—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:', event.error);
    tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');
});
    </script>
</body>
</html>